<div class="box box-success">
    <div class="box-header with-border">
        <h3 class="box-title box-title-lg">Timeplan {{ currentSemester }}</h3>
        <div class="pull-right"><h3 class="box-title" style="vertical-align: middle;">Uke <span
                        id="weekNumber">{{ week }}</span></h3>&nbsp;&nbsp;&nbsp;
            <button onclick="prevWeek()" class="btn btn-primary btn-xs btn-flat"><i class="fa fa-chevron-left"></i></button>
            <button onclick="thisWeek()" class="btn btn-primary btn-xs btn-flat">Denne uken</button>
            <button onclick="nextWeek()" class="btn btn-primary btn-xs btn-flat"><i class="fa fa-chevron-right"></i></button>
        </div>
    </div>
    <div class="box-body">
        <div class="table-responsive">
            <table id="timeTable" class="table table-striped table-fixed">
                <thead>
                <tr>
                    <th>Dag</th>
                    <th>Kurs</th>
                    <th>Tid</th>
                    <th>Sted</th>
                </tr>
                </thead>
                <tbody>
                {% for class in courseClasses %}
                    <tr timestamp="{{ class.time|date('U') }}">
                        <td>{{ class.dayNorwegian }}</td>
                        <td><a href="{{ path('course_info', {id: class.course.id, subdomain: 'test'}) }}">{{ class.course.name }}</a></td>
                        <td>{{ class.time|date('H:i') }}</td>
                        <td>{{ class.place }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            {% if (not courseClasses|length) %}<h4>Ingen kurs denne uken</h4>{% endif %}
        </div>
    </div>
</div>

<script>
    var week = {{ week }};
    var $loadingWheel;
    document.addEventListener("DOMContentLoaded", function () {
        sortTable();

        //Cache loading wheel
        var size = 50;
        $loadingWheel = loading.clone();
        $loadingWheel.attr('width', size);
        $loadingWheel.attr('height', size);
        $loadingWheel.addClass('center-block');
    });


    function nextWeek() {
        week = week >= 52 ? 1 : week + 1;
        loadTableData(week);
    }

    function prevWeek() {
        week = week <= 1 ? 52 : week - 1;
        loadTableData(week);
    }

    function thisWeek() {
        week = (new Date()).getWeekNumber();
        loadTableData(week);
    }

    function loadTableData(week) {
        //Change week number in timetable
        $('#weekNumber').html(week);

        var $timeTable = $('#timeTable');
        var $tbody = $timeTable.find('tbody');

        //Clear table
        $tbody.empty();
        $timeTable.parent().children('h4').remove();

        //Show loading wheel
        $timeTable.parent().append($loadingWheel);

        $.get('/api/kurs/uke/' + week, function (data) {
            var $rows = $('<div></div>');
            if (data.length === 0) {
                $timeTable.parent().append($('<h4></h4>').html('Ingen kurs denne uken'));
            }
            data.forEach(function (courseClass) {
                var $tr = $('<tr></tr>');
                var unixTime = new Date(courseClass['datetime'].date).getTime();

                //Add timestamp to row. Used for sorting
                $tr.attr('timestamp', unixTime);

                //Append class data to row
                $tr.append($('<td></td>').html(courseClass.day));
                $tr.append($('<td></td>').html(courseClass.course));
                $tr.append($('<td></td>').html(courseClass.time));
                $tr.append($('<td></td>').html(courseClass.place));

                $rows.append($tr);
            });

            //Remove loadingWheel
            $timeTable.parent().children('img').remove();

            $tbody.append($rows.children());
            sortTable();
        })
    }

    function sortTable() {
        sortTableByAttribute($('#timeTable'), 'timestamp', true);
    }

</script>